// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum StockMethod {
  FIFO
  LIFO
}

model Product {
  id            Int              @id @default(autoincrement())
  name          String           @db.VarChar(255)
  sku           String           @unique @db.VarChar(100)
  stockMethod   StockMethod      @default(FIFO)
  sellingPrice  Decimal          @db.Decimal(10, 2)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  inventoryBatches      InventoryBatch[]
  saleItems             SaleItem[]
  variants              Variant[]
  variantValues         VariantValue[]
  variantCombinations   VariantCombination[]

  @@index([sku])
  @@map("products")
}

model Variant {
  id          Int      @id @default(autoincrement())
  productId   Int
  name        String   @db.VarChar(100)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  values  VariantValue[]

  @@index([productId])
  @@map("variants")
}

model VariantValue {
  id          Int      @id @default(autoincrement())
  variantId   Int
  productId   Int
  name        String   @db.VarChar(100)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  variant                    Variant                      @relation(fields: [variantId], references: [id], onDelete: Cascade)
  product                    Product                      @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantCombinationValues   VariantCombinationValue[]

  @@index([variantId])
  @@index([productId])
  @@map("variant_values")
}

model VariantCombination {
  id          Int      @id @default(autoincrement())
  productId   Int
  sku         String   @unique @db.VarChar(100)
  price       Decimal  @db.Decimal(10, 2)
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  product Product                   @relation(fields: [productId], references: [id], onDelete: Cascade)
  values  VariantCombinationValue[]

  @@index([productId])
  @@index([sku])
  @@map("variant_combinations")
}

model VariantCombinationValue {
  combinationId   Int
  variantValueId  Int
  
  combination VariantCombination @relation(fields: [combinationId], references: [id], onDelete: Cascade)
  variantValue VariantValue      @relation(fields: [variantValueId], references: [id], onDelete: Cascade)

  @@id([combinationId, variantValueId])
  @@index([combinationId])
  @@index([variantValueId])
  @@map("variant_combination_values")
}

model InventoryBatch {
  id                Int      @id @default(autoincrement())
  productId         Int
  quantity          Int
  remainingQuantity Int
  costPrice         Decimal  @db.Decimal(10, 2)
  createdAt         DateTime @default(now())
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, createdAt])
  @@map("inventory_batches")
}

model Sale {
  id          Int      @id @default(autoincrement())
  saleDate    DateTime @default(now())
  totalAmount Decimal  @db.Decimal(10, 2)
  totalCogs   Decimal  @db.Decimal(10, 2)
  profit      Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  
  saleItems SaleItem[]

  @@index([saleDate])
  @@map("sales")
}

model SaleItem {
  id           Int     @id @default(autoincrement())
  saleId       Int
  productId    Int
  quantity     Int
  sellingPrice Decimal @db.Decimal(10, 2)
  cogs         Decimal @db.Decimal(10, 2)
  
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}
